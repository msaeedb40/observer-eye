"""
Vulnerability and Compliance models for Observer-Eye Platform.
Tracks vulnerability scanning, compliance checks, and security incidents.
"""
from django.db import models
from core.models import BaseModel, ObservabilityMixin


class VulnerabilityScan(BaseModel):
    """CVE/Vulnerability scanning results."""
    host = models.CharField(max_length=255, db_index=True)
    scan_type = models.CharField(
        max_length=50,
        choices=[
            ('container', 'Container'),
            ('host', 'Host'),
            ('dependency', 'Dependency'),
            ('infrastructure', 'Infrastructure'),
        ],
        default='host'
    )
    
    # CVE details
    cve_id = models.CharField(max_length=50, db_index=True)
    severity = models.CharField(
        max_length=20,
        choices=[
            ('critical', 'Critical'),
            ('high', 'High'),
            ('medium', 'Medium'),
            ('low', 'Low'),
            ('unknown', 'Unknown'),
        ],
        db_index=True
    )
    cvss_score = models.FloatField(null=True, blank=True)
    cvss_vector = models.CharField(max_length=100, blank=True)
    
    # Package details
    package_name = models.CharField(max_length=255)
    package_version = models.CharField(max_length=100)
    fixed_version = models.CharField(max_length=100, blank=True)
    
    # Remediation
    remediation_status = models.CharField(
        max_length=50,
        choices=[
            ('open', 'Open'),
            ('in_progress', 'In Progress'),
            ('resolved', 'Resolved'),
            ('accepted', 'Risk Accepted'),
            ('false_positive', 'False Positive'),
        ],
        default='open'
    )
    remediation_notes = models.TextField(blank=True)
    
    # Timing
    first_detected = models.DateTimeField(auto_now_add=True)
    last_seen = models.DateTimeField(auto_now=True)
    resolved_at = models.DateTimeField(null=True, blank=True)
    
    class Meta:
        verbose_name = 'Vulnerability Scan'
        verbose_name_plural = 'Vulnerability Scans'
        indexes = [
            models.Index(fields=['host', 'cve_id']),
            models.Index(fields=['severity', 'remediation_status']),
        ]

    def __str__(self):
        return f"{self.cve_id} ({self.severity}) - {self.package_name}"


class ComplianceFramework(BaseModel):
    """Compliance framework definition."""
    name = models.CharField(max_length=100, unique=True)  # SOC2, HIPAA, PCI-DSS, GDPR
    version = models.CharField(max_length=50)
    description = models.TextField(blank=True)
    controls = models.JSONField(default=list)
    is_active = models.BooleanField(default=True)
    
    class Meta:
        verbose_name = 'Compliance Framework'
        verbose_name_plural = 'Compliance Frameworks'

    def __str__(self):
        return f"{self.name} {self.version}"


class ComplianceCheck(BaseModel):
    """Individual compliance check result."""
    framework = models.ForeignKey(ComplianceFramework, on_delete=models.CASCADE, related_name='checks')
    control_id = models.CharField(max_length=50, db_index=True)
    control_name = models.CharField(max_length=255)
    category = models.CharField(max_length=100, blank=True)
    
    status = models.CharField(
        max_length=20,
        choices=[
            ('pass', 'Pass'),
            ('fail', 'Fail'),
            ('na', 'N/A'),
            ('pending', 'Pending'),
            ('manual', 'Manual Review'),
        ],
        default='pending'
    )
    
    # Evidence
    evidence = models.JSONField(default=dict, blank=True)
    notes = models.TextField(blank=True)
    
    # Timing
    last_checked = models.DateTimeField()
    next_check = models.DateTimeField(null=True, blank=True)
    
    class Meta:
        verbose_name = 'Compliance Check'
        verbose_name_plural = 'Compliance Checks'
        unique_together = ['framework', 'control_id']

    def __str__(self):
        return f"{self.framework.name} - {self.control_id}: {self.status}"


class SecurityIncident(BaseModel):
    """Security incident tracking."""
    incident_id = models.CharField(max_length=50, unique=True, db_index=True)
    title = models.CharField(max_length=255)
    description = models.TextField()
    
    severity = models.CharField(
        max_length=20,
        choices=[
            ('critical', 'Critical'),
            ('high', 'High'),
            ('medium', 'Medium'),
            ('low', 'Low'),
        ],
        db_index=True
    )
    
    status = models.CharField(
        max_length=50,
        choices=[
            ('open', 'Open'),
            ('investigating', 'Investigating'),
            ('contained', 'Contained'),
            ('remediated', 'Remediated'),
            ('resolved', 'Resolved'),
            ('closed', 'Closed'),
        ],
        default='open',
        db_index=True
    )
    
    category = models.CharField(
        max_length=100,
        choices=[
            ('data_breach', 'Data Breach'),
            ('malware', 'Malware'),
            ('phishing', 'Phishing'),
            ('unauthorized_access', 'Unauthorized Access'),
            ('dos', 'Denial of Service'),
            ('insider_threat', 'Insider Threat'),
            ('other', 'Other'),
        ],
        db_index=True
    )
    
    # Scope
    affected_systems = models.JSONField(default=list)
    affected_users = models.JSONField(default=list)
    
    # Timeline
    timeline = models.JSONField(default=list)  # List of events with timestamps
    detected_at = models.DateTimeField()
    contained_at = models.DateTimeField(null=True, blank=True)
    resolved_at = models.DateTimeField(null=True, blank=True)
    
    # Assignment
    assignee = models.CharField(max_length=255, blank=True)
    team = models.CharField(max_length=100, blank=True)
    
    # Root cause and lessons
    root_cause = models.TextField(blank=True)
    lessons_learned = models.TextField(blank=True)
    
    class Meta:
        verbose_name = 'Security Incident'
        verbose_name_plural = 'Security Incidents'
        ordering = ['-detected_at']

    def __str__(self):
        return f"{self.incident_id}: {self.title}"


class SecurityPolicy(BaseModel):
    """Security policy definitions."""
    name = models.CharField(max_length=255, unique=True)
    description = models.TextField()
    category = models.CharField(max_length=100)  # access_control, encryption, network
    
    rules = models.JSONField(default=list)
    is_enabled = models.BooleanField(default=True)
    enforcement_mode = models.CharField(
        max_length=20,
        choices=[
            ('monitor', 'Monitor Only'),
            ('warn', 'Warn'),
            ('enforce', 'Enforce'),
        ],
        default='monitor'
    )
    
    # Applicable scope
    applies_to = models.JSONField(default=list)  # hosts, namespaces, services
    
    class Meta:
        verbose_name = 'Security Policy'
        verbose_name_plural = 'Security Policies'

    def __str__(self):
        return f"{self.name} ({self.enforcement_mode})"
